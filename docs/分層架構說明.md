# 分層架構說明

## 📐 架構原則

### 🎯 核心原則
**基本操作在 base 層，page 層只呼叫方法和給參數**

- **Base 層**：所有基本 UI 操作方法（點擊、輸入、視窗管理等）
- **Page 層**：業務邏輯、參數配置、流程組織

---

## 🏗️ Base 層核心方法

### 📂 `base/desktop_app.py`

#### 1️⃣ 點擊操作

| 方法 | 說明 | 參數 |
|------|------|------|
| `_perform_click()` | 底層點擊執行 | x, y, clicks, click_type |
| `smart_click()` | 智能點擊（圖片/OCR/座標） | x_ratio, y_ratio, target_text, image_path, timeout, clicks, click_type |

**特性**：
- 支援單擊、雙擊、右鍵
- 圖片辨識 → OCR 文字 → 座標保底
- 自學習座標庫

#### 2️⃣ Checkbox 操作

| 方法 | 說明 | 參數 |
|------|------|------|
| `smart_checkbox()` | 智能勾選/取消勾選 | x_ratio, y_ratio, target_text, image_path, checked_image, unchecked_image, ensure_checked |
| `_locate_checkbox()` | 定位 checkbox | 同上 |
| `_is_checkbox_checked()` | 判斷勾選狀態 | x, y, checked_image, unchecked_image |

**特性**：
- 自動判斷當前狀態
- 只在需要時點擊
- 圖片辨識 + 像素分析雙重驗證

#### 3️⃣ 鍵盤操作

| 方法 | 說明 | 參數 |
|------|------|------|
| `type_text()` | 輸入文字 | text, interval |
| `press_key()` | 按下按鍵 | key |

**支援的按鍵**：`'enter'`, `'esc'`, `'tab'`, `'backspace'` 等

#### 4️⃣ 視窗管理

| 方法 | 說明 | 參數 |
|------|------|------|
| `get_nx_window()` | 獲取主視窗 | 無 |
| `activate_window()` | 啟動指定視窗 | window_obj |
| `find_window()` | 尋找符合條件的視窗 | title_keywords, max_width, max_height, exclude_titles |
| `wait_for_window()` | 等待視窗出現 | window_titles, timeout |
| `wait_for_window_close()` | 等待視窗關閉 | window_titles, timeout |

#### 5️⃣ 彈窗處理

| 方法 | 說明 | 參數 |
|------|------|------|
| `handle_password_popup()` | 處理密碼彈窗 | password, popup_title_keywords, input_x_ratio, input_y_ratio |

**特性**：
- 自動偵測彈窗
- 點擊輸入框 → 輸入密碼 → 按 Enter

#### 6️⃣ 輔助工具

| 方法 | 說明 | 參數 |
|------|------|------|
| `wait_for_condition()` | 通用條件等待 | condition_func, timeout, check_interval |
| `wait_for_screen_change()` | 等待螢幕變化 | region, threshold, max_wait |
| `_get_ocr_engine()` | 延遲載入 OCR | 無 |
| `_find_text_by_ocr()` | OCR 文字定位 | target_text, region |

---

## 📄 Page 層架構

### 📂 `pages/desktop/server_settings_page.py`

#### ✅ 正確的 Page 層寫法

```python
def enable_usb_detection(self):
    """勾選 USB 攝影機自動偵測"""
    # ✅ 只呼叫 base 方法，傳入參數
    success = self.smart_checkbox(
        x_ratio=0.3,
        y_ratio=0.42,
        target_text="USB",
        image_path="desktop_settings/usb_checkbox.png",
        checked_image="desktop_settings/checkbox_checked.png",
        unchecked_image="desktop_settings/checkbox_unchecked.png",
        ensure_checked=True,
        timeout=3
    )
    return success
```

#### ❌ 錯誤的 Page 層寫法

```python
def enable_usb_detection(self):
    """勾選 USB 攝影機自動偵測"""
    # ❌ 不要在 page 層直接使用 pyautogui
    import pyautogui
    pyautogui.click(500, 400)
    
    # ❌ 不要在 page 層實現基本操作邏輯
    for win in gw.getAllWindows():
        if "密碼" in win.title:
            win.activate()
            pyautogui.typewrite("password")
```

---

## 🎯 分層範例

### 範例 1: 處理密碼彈窗

#### ❌ 重構前（Page 層實現細節）

```python
# pages/desktop/server_settings_page.py
def _handle_password_confirmation(self):
    wins = gw.getAllWindows()
    for win in wins:
        if "密碼" in win.title:
            win.activate()
            time.sleep(0.3)
            
            input_x = win.left + int(win.width * 0.5)
            input_y = win.top + int(win.height * 0.45)
            pyautogui.click(input_x, input_y)
            
            password = "1q2w!Q@W"
            pyautogui.typewrite(password, interval=0.05)
            pyautogui.press('enter')
```

#### ✅ 重構後（Page 層只呼叫 + 配置參數）

```python
# pages/desktop/server_settings_page.py
def _handle_password_confirmation(self):
    from config import EnvConfig
    password = getattr(EnvConfig, 'ADMIN_PASSWORD', '')
    
    # 調用 base 層方法，只傳參數
    return self.handle_password_popup(
        password=password,
        popup_title_keywords=["需要再次確認", "確認密碼"],
        input_x_ratio=0.5,
        input_y_ratio=0.45
    )

# base/desktop_app.py
def handle_password_popup(self, password, popup_title_keywords, input_x_ratio, input_y_ratio):
    # Base 層實現所有細節
    window = self.find_window(title_keywords=popup_title_keywords, ...)
    self.activate_window(window)
    self._perform_click(input_x, input_y)
    self.type_text(password)
    self.press_key('enter')
```

### 範例 2: 右鍵點擊

#### ❌ 重構前

```python
# pages/camera_page.py
def open_add_camera_dialog(self):
    success = self.smart_click(...)
    if not success:
        return False
    
    pyautogui.rightClick()  # ❌ 直接使用 pyautogui
```

#### ✅ 重構後

```python
# pages/camera_page.py
def open_add_camera_dialog(self):
    success = self.smart_click(
        x_ratio=0.05,
        y_ratio=0.15,
        image_path="desktop_main/server_node.png",
        target_text="Server",
        click_type='right'  # ✅ 使用 base 層的參數
    )
```

---

## 📊 重構成果統計

### 新增的 Base 層方法

| 方法 | 行數 | 功能 |
|------|------|------|
| `type_text()` | 7 | 鍵盤輸入文字 |
| `press_key()` | 7 | 按下按鍵 |
| `activate_window()` | 12 | 啟動視窗 |
| `find_window()` | 38 | 尋找視窗 |
| `wait_for_window_close()` | 21 | 等待視窗關閉 |
| `handle_password_popup()` | 61 | 處理密碼彈窗 |
| **總計** | **146** | **6 個通用方法** |

### Page 層簡化統計

| 文件 | 重構前 | 重構後 | 減少 |
|------|--------|--------|------|
| `server_settings_page.py` | 338 行 | 194 行 | **-43%** |
| `camera_page.py` | 30 行 | 27 行 | **-10%** |

### Import 依賴清理

| 文件 | 重構前 | 重構後 |
|------|--------|--------|
| `server_settings_page.py` | `pyautogui`, `gw`, `np` | 只有 `time` |
| `camera_page.py` | `pyautogui` | 無額外依賴 |

---

## 🎓 開發指南

### 添加新功能時

1. **先檢查 Base 層**是否已有對應方法
2. **若無，先在 Base 層實現**通用方法
3. **Page 層只做**：
   - 業務邏輯組織
   - 參數配置（座標、圖片路徑、文字）
   - 流程編排（先做 A 再做 B）

### 重構現有代碼時

1. 找出 Page 層的 `pyautogui` 直接調用
2. 抽象為通用方法，移到 Base 層
3. Page 層改為呼叫 Base 方法
4. 清理不必要的 import

---

## 📖 總結

### ✅ 優點

1. **可維護性** ↑：基本操作集中管理
2. **可測試性** ↑：每個層次職責清晰
3. **可擴展性** ↑：新增功能只需調整參數
4. **代碼量** ↓：Page 層代碼減少 40%+
5. **依賴性** ↓：Page 層不直接依賴 pyautogui

### 🎯 核心理念

> **Base 層提供工具，Page 層使用工具**
> 
> 就像蓋房子：Base 層是「鐵鎚、鋸子、螺絲刀」，Page 層是「建築師」，使用這些工具完成設計

---

**📅 最後更新**: 2026-01-14  
**👨‍💻 架構版本**: v2.0 (分層重構完成)
