# 測試驗證與報告功能說明

## 功能概述

### 1. 連續圖像辨識失敗檢測

**規則**：連續三個需要圖像辨識的物件，沒有使用圖像辨識成功，就判定 Fail

**實現方式**：
- 在 `ok_script_recognizer.py` 中追蹤連續失敗次數
- 每次使用保底座標時，增加連續失敗計數
- 每次圖像辨識成功（OK Script、pyautogui、OCR、VLM）時，重置計數
- 在 `test_runner.py` 中，每個步驟執行後檢查連續失敗次數
- 如果連續失敗 >= 3，立即停止測試並標記為 Fail

### 2. HTML 測試報告生成

**報告結構**：
```
report/
└── <TestName>/
    └── <YYYY-MM-DD_HH-MM-SS>/
        ├── report.html          # 主報告檔案
        └── screenshots/         # 截圖目錄
            ├── step_001_xxx.png
            ├── step_002_xxx.png
            └── ...
```

**報告內容**：
- 測試摘要（通過/失敗/警告步驟數、執行時長）
- 每個步驟的詳細資訊：
  - 步驟編號和名稱
  - 執行狀態（Pass/Fail/Warning）
  - 執行訊息
  - 檢核物件列表
  - 全屏截圖（紅框標出檢核物件）

**報告格式**：
- 類似 UFT 的 HTML 報告格式
- 現代化的 UI 設計（漸層背景、卡片式佈局）
- 響應式設計（可在瀏覽器中查看）

## 技術實現

### 1. 連續失敗追蹤

**檔案**：`base/ok_script_recognizer.py`

```python
# 添加追蹤連續失敗的屬性
self._consecutive_image_recognition_failures = 0

# 記錄座標保底時增加計數
def record_coordinate_hit(self):
    self.stats.coordinate_hits += 1
    self._consecutive_image_recognition_failures += 1

# 圖像辨識成功時重置計數
def record_image_recognition_success(self):
    self._consecutive_image_recognition_failures = 0
```

**檔案**：`base/desktop_app.py`

```python
# 在所有圖像辨識成功的地方調用
recognizer.record_image_recognition_success()
```

### 2. 測試報告生成

**檔案**：`engine/test_reporter.py`

**主要類別**：`TestReporter`

**核心方法**：
- `add_step()`: 添加測試步驟，自動截圖並標註檢核物件
- `finish()`: 完成報告生成
- `_take_screenshot_with_annotations()`: 截圖並在圖中標出紅框

### 3. 測試執行整合

**檔案**：`tests/test_runner.py`

**改進點**：
- 在每個步驟執行後檢查連續失敗次數
- 如果連續失敗 >= 3，立即停止測試
- 整合 `TestReporter` 生成報告
- 在測試結束時生成 HTML 報告

## 使用方式

### 執行測試

```bash
pytest tests/test_runner.py --test_name "啟用免費一個月的錄製授權" -v -s
```

### 查看報告

測試完成後，報告會自動生成在：
```
report/
└── 啟用免費一個月的錄製授權/
    └── 2026-01-16_15-30-45/
        └── report.html
```

直接在瀏覽器中打開 `report.html` 即可查看。

## 驗證規則

### 規則 1: 連續圖像辨識失敗

- **觸發條件**：連續 3 次使用保底座標
- **處理方式**：立即停止測試，標記為 Fail
- **錯誤訊息**：顯示連續失敗次數和可能的原因

### 規則 2: 保底座標使用率

- **觸發條件**：保底座標使用率 > 30%
- **處理方式**：測試結束後標記為 Fail
- **錯誤訊息**：顯示使用率和建議

## 報告功能特點

1. **自動截圖**：每個步驟自動截取全屏
2. **物件標註**：在截圖中用紅框標出檢核物件
3. **詳細資訊**：顯示步驟狀態、訊息、時間戳
4. **統計摘要**：顯示通過/失敗/警告步驟數
5. **現代化 UI**：漸層背景、卡片式佈局、響應式設計

## 後續改進建議

1. **更細粒度的物件座標追蹤**：
   - 在 `smart_click` 中返回辨識方法和座標資訊
   - 自動記錄檢核物件的座標和尺寸

2. **步驟間的驗證**：
   - 在點擊物件後，驗證下一個步驟的目標是否出現
   - 如果目標不存在，標記為失敗

3. **報告增強**：
   - 添加執行時間圖表
   - 添加辨識方法統計圖表
   - 支援匯出 PDF 格式
